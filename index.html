<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rent vs Mortgage (Updated)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
      margin: 0; padding: 2rem; background: #f5f5f7; min-height: 100vh; color: #1d1d1f; line-height: 1.47059;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .container {
      max-width: 1400px; margin: 0 auto; background: rgba(255, 255, 255, 0.8);
      backdrop-filter: saturate(180%) blur(20px); border-radius: 18px; padding: 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12); border: 1px solid rgba(255, 255, 255, 0.18);
    }
    h1 { text-align: center; font-size: 2.5rem; font-weight: 600; margin-bottom: 2rem; letter-spacing: -0.015em; }
    h2 { font-size: 1.5rem; font-weight: 600; margin: 2rem 0 1rem; letter-spacing: -0.01em; }
    h3 { font-size: 1.375rem; font-weight: 600; margin-top: 2rem; letter-spacing: -0.01em; }
    .input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
    .input-group {
      background: rgba(255,255,255,0.7); padding: 1.25rem; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1);
      transition: all .2s cubic-bezier(.4,0,.25,1); backdrop-filter: blur(10px);
    }
    .input-group:hover { background: rgba(255,255,255,.9); box-shadow: 0 4px 20px rgba(0,0,0,.08); transform: translateY(-1px); border-color: rgba(0,0,0,.15); }
    label { display: block; margin-bottom: .5rem; font-weight: 500; font-size: .875rem; letter-spacing: -0.01em; }
    input[type="number"], select {
      width: 100%; padding: 12px 16px; border: 1px solid rgba(0,0,0,.15); border-radius: 8px; font-size: 1rem;
      transition: all .2s cubic-bezier(.4,0,.25,1); background: rgba(255,255,255,.9);
    }
    input[type="number"]:focus, select:focus { outline: none; border-color: #007aff; box-shadow: 0 0 0 4px rgba(0,122,255,.12); background: #fff; }
    .input-with-select { display: flex; gap: 8px; }
    .input-with-select input, .input-with-select select { flex: 1; }
    .single-input { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 1rem; }
    button {
      display: inline-block; padding: 12px 20px; background: #007aff; color: #fff; border: none; border-radius: 12px;
      font-size: 1rem; font-weight: 500; cursor: pointer; transition: all .2s cubic-bezier(.4,0,.25,1); box-shadow: 0 2px 8px rgba(0,122,255,.25);
      margin-right: 10px;
    }
    .primary-actions { display: flex; justify-content: center; gap: 10px; margin: 1.25rem 0 1rem; flex-wrap: wrap; }
    button:hover { background: #0051d5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,122,255,.35); }
    button:active { transform: translateY(0); background: #004fc7; }
    .results-container { margin-top: 1rem; }
    .summary {
      background: linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); padding: 2rem; border-radius: 15px; margin-bottom: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,.1);
    }
    .summary-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap: 1rem; }
    .summary-item { background: #fff; padding: 1rem; border-radius: 8px; border-left: 4px solid #3498db; box-shadow: 0 2px 4px rgba(0,0,0,.1); }
    .table-controls {
      display:flex; align-items:center; gap:.75rem; margin: .5rem 0 1rem;
    }
    .table-controls label { margin:0; font-size:.9rem; }
    .table-container {
      overflow: auto; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,.08); background: rgba(255,255,255,.8);
      backdrop-filter: blur(20px); border: 1px solid rgba(0,0,0,.1); max-height: 70vh; margin-bottom: 1.25rem;
    }
    table { width: 100%; border-collapse: collapse; font-size: .875rem; min-width: 1900px; background: transparent; }
    th, td { padding: 12px 8px; border-bottom: 1px solid rgba(0,0,0,.08); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    th { background: rgba(248,248,248,.95); text-align: center; position: sticky; top: 0; z-index: 10; font-weight: 500; font-size: .75rem; letter-spacing: -0.01em; border-bottom: 1px solid rgba(0,0,0,.12); backdrop-filter: blur(20px); }
    th:first-child, td:first-child { text-align: left; position: sticky; left: 0; background: rgba(255,255,255,.95); z-index: 5; border-right: 1px solid rgba(0,0,0,.08); backdrop-filter: blur(20px); }
    th:first-child { background: rgba(248,248,248,.95); z-index: 11; }
    tbody tr:nth-child(even) { background-color: rgba(248,248,248,.3); }
    tbody tr:nth-child(even) td:first-child { background-color: rgba(248,248,248,.5); }
    tbody tr:hover { background-color: rgba(0,122,255,.04); }
    tbody tr:hover td:first-child { background-color: rgba(0,122,255,.06); }
    .positive { color: #30d158; font-weight: 500; }
    .negative { color: #ff3b30; font-weight: 500; }
    .totals-row { background: rgba(28,28,30,.95) !important; color: #fff !important; font-weight: 500; font-size: .875rem; }
    .totals-row td { background: rgba(28,28,30,.95) !important; color: #fff !important; border-color: rgba(255,255,255,.1) !important; }
    .charts { display: grid; gap: 24px; margin-bottom: 1rem; }
    .chart-card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,.08); }
    .chart-card h4 { margin: 0 0 12px; font-weight: 600; }
    .row { display:flex; gap:.5rem; align-items:center; margin-bottom:.5rem; }
    .row select, .row input[type="number"] { max-width: 170px; }
    .chip { display:inline-flex; align-items:center; gap:.4rem; background:#f2f2f7; padding:.25rem .6rem; border-radius:999px; font-size:.8rem; }
    .muted { color:#6e6e73; font-size:.9rem; }
    .link { color:#007aff; cursor:pointer; text-decoration:underline; }
    .danger { color:#ff3b30; cursor:pointer; }
    .toolbar { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; justify-content:center; margin-top:.5rem; }

/* ---- Lightweight, design-matched tooltips ---- */
.has-tip {
  position: relative;
  cursor: help;
  text-decoration: underline dotted rgba(0,0,0,.25);
  text-underline-offset: 2px;
  border-radius: 4px; /* for focus ring */
}
.has-tip:focus-visible {
  outline: none;
  box-shadow: 0 0 0 4px rgba(0,122,255,.12); /* matches your focus styles */
}

/* Balloon */
.has-tip::before {
  content: attr(data-tip);
  position: absolute;
  left: 50%;
  bottom: calc(100% + 12px);
  transform: translate(-50%, 6px);
  opacity: 0;
  pointer-events: none;
  transition: opacity .15s ease, transform .15s ease;
  background: rgba(255,255,255,.98);
  color: #1d1d1f;
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 12px;               /* matches your cards */
  box-shadow: 0 8px 24px rgba(0,0,0,.12);
  padding: 10px 12px;
  font-size: .875rem;
  line-height: 1.35;
  max-width: 320px;
  min-width: 220px;
  white-space: pre-line;             /* lets us use \A (newlines) */
  z-index: 20;
}

/* Arrow */
.has-tip::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: calc(100% + 6px);
  transform: translate(-50%, 6px) rotate(45deg);
  width: 10px; height: 10px;
  background: rgba(255,255,255,.98);
  border-left: 1px solid rgba(0,0,0,.12);
  border-top: 1px solid rgba(0,0,0,.12);
  opacity: 0;
  transition: opacity .15s ease, transform .15s ease;
  z-index: 19;
}

/* Show on hover/focus (and when toggled for touch) */
.has-tip:hover::before,
.has-tip:hover::after,
.has-tip:focus-visible::before,
.has-tip:focus-visible::after,
.has-tip[data-open="true"]::before,
.has-tip[data-open="true"]::after {
  opacity: 1;
  transform: translate(-50%, 0);
}

/* If you provide a US average, we append it nicely. */
.has-tip[data-average]::before {
  content: attr(data-tip) "\A\A" "US average: " attr(data-average);
  /* Example: set data-average="~0.5%‚Äì1.0% of home value/yr (varies by state)" */
}
  /* --- Toolbar typography & alignment overrides --- */
.toolbar { 
  font-size: 1rem;            /* pick the size you want for all toolbar items */
  line-height: inherit;
}

.toolbar label,
.toolbar input,
.toolbar select,
.toolbar span {
  font-family: inherit;
  font-size: inherit;         /* everything inherits 1rem */
  line-height: inherit;
  color: inherit;
}

/* keep the label on one line */
.toolbar .has-tip { white-space: nowrap; }

/* push the select to the right when desired */
.push-right { margin-left: auto; }

/* optional: minimal select reset so it matches your UI */
.toolbar select {
  border: 1px solid rgba(0,0,0,.15);
  border-radius: 8px;
  padding: .25rem .5rem;
  background: #fff;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}


</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
</head>
<body>
<div class="container">
  <h1>Rent vs Buy Calculator</h1>


  <h2>üè† Home Purchase</h2>
  <div class="input-grid">
    <div class="input-group"><label for="homePrice">Home Price ($)</label><input type="number" id="homePrice" value="400000" min="0"></div>
    <div class="input-group">
      <label for="downPaymentValue">Down Payment</label>
      <div class="input-with-select">
        <input type="number" id="downPaymentValue" value="20" min="0">
        <select id="downPaymentType"><option value="percent">% of Home Price</option><option value="amount">Fixed Amount</option></select>
      </div>
    </div>
    <div class="input-group"><label for="interestRate"><span class="has-tip"
        tabindex="0"
        data-tip="Current U.S. mortgage rates average about 6.5%‚Äì6.6% for a 30-year fixed loan (Aug. 2025).">
Mortgage Interest Rate (%)</label><input type="number" id="interestRate" value="6.5" step="0.01" min="0"></div>
    <div class="input-group"><label for="loanTerm">Loan Term (years)</label><input type="number" id="loanTerm" value="30" min="1"></div>
    <div class="input-group"><label for="customMonthlyPayment"><span class="has-tip"
        tabindex="0"
        data-tip="Entering a monthly payment overrides the loan term and recalculates how long it will take to pay off the loan.">
Custom Monthly Payment ($ - Optional)</label><input type="number" id="customMonthlyPayment" placeholder="Leave blank for calculated" min="0"></div>
    <div class="input-group"><label for="closingCostsBuy"><span class="has-tip"
        tabindex="0"
        data-tip="Closing costs usually run 2%‚Äì5% of the loan or purchase price and cover fees such as appraisal, title search, title insurance, lender charges, and escrow services.">
Closing Costs on Purchase (%)</label><input type="number" id="closingCostsBuy" value="2" step="0.01" min="0"></div>
    <div class="input-group"><label for="closingCostsSell"><span class="has-tip"
        tabindex="0"
        data-tip="Selling costs are the expenses you pay when selling your home, such as agent commissions, title and escrow fees, and transfer taxes. They typically total around 6%‚Äì8% of the home‚Äôs selling price, though the exact amount can vary by location and services.">




Selling Costs (%)</label><input type="number" id="closingCostsSell" value="6" step="0.01" min="0"></div>
    <div class="input-group"><label for="appreciationRate"><span class="has-tip"
        tabindex="0"
        data-tip="The home appreciation rate estimates how much your property value will grow each year. It‚Äôs important for projecting future equity and resale value. Historically, U.S. home prices have risen about 3%‚Äì4% annually, though this varies widely by market and economic conditions.">

Home Appreciation Rate (%)</label><input type="number" id="appreciationRate" value="3" step="0.01"></div>
    <div class="input-group"><label for="savingsReturnRate"><span class="has-tip"
        tabindex="0"
        data-tip="Interest return on savings is used to estimate the opportunity cost of not investing your down payment. The calculator also assumes that any monthly cost difference between renting and buying is invested at this rate. As a benchmark, long-term stock market returns average around 5%‚Äì7% annually, while safer options like bonds or high-yield savings accounts may return 3%‚Äì4%.">
Investment Return on Savings (%)</label><input type="number" id="savingsReturnRate" value="6" step="0.01" min="0"></div>
  </div>

  <h3>üßæ Property Tax</h3>
  <div class="input-grid">
    <div class="input-group">
      <label for="propertyTaxValue">
  <span class="has-tip"
        tabindex="0"
        data-tip="Property taxes are billed once a year by local governments - typically your city, county, school district, and similar agencies. To ballpark the tax on a specific home, look it up on your area‚Äôs appraisal district or assessor website; those records are usually public. In many places, homeowners pay about 1%‚Äì3% of a home‚Äôs value annually.">
    Property Tax
  </span>
</label>
      <div class="input-with-select">
        <input type="number" id="propertyTaxValue" value="1.5" step="0.01" min="0">
        <select id="propertyTaxType"><option value="percent">% of Home Price</option><option value="amount">Fixed Annual Amount</option></select>
      </div>
    </div>
    <div class="input-group"><label for="propertyTaxInflation">Property Tax Inflation (%)</label><input type="number" id="propertyTaxInflation" value="3" step="0.01" min="0"></div>
  </div>

  <h2>üõ°Ô∏è Home Insurance</h2>
  <div class="input-grid">
    <div class="input-group">
      <label for="homeInsuranceValue">
<span class="has-tip"
        tabindex="0"
        data-tip="Lenders typically require homeowners insurance for major hazards, and conventional loans with under 20% down usually add PMI. As a quick benchmark, U.S. homeowners insurance averages about 0.6%‚Äì0.7% of a home‚Äôs value per year (premiums are based on rebuild cost and vary by location). To find local figures, check state averages from the NAIC/Insurance Information Institute, consumer trackers like Bankrate, or your state insurance department and local carrier quotes.">
Home Insurance</label>
      <div class="input-with-select">
        <input type="number" id="homeInsuranceValue" value="1500" min="0">
        <select id="homeInsuranceType"><option value="amount">Fixed Annual Amount</option><option value="percent">% of Home Price</option></select>
      </div>
    </div>
    <div class="input-group"><label for="insuranceInflation">Insurance Inflation (%)</label><input type="number" id="insuranceInflation" value="3" step="0.01" min="0"></div>
  </div>

 <h2>üèòÔ∏è HOA Fees</h2>
<div class="input-grid">
  <div class="input-group">
    <label for="hoaFees">
      <span class="has-tip"
        tabindex="0"
        data-tip="HOA fees are mandatory monthly charges set by homeowners associations to cover shared community costs such as landscaping, amenities, maintenance, and sometimes utilities. They vary widely by location and services, typically ranging from under $100 to several hundred dollars per month, and can increase over time.">
        HOA Fees (Monthly $)
      </span>
    </label>
    <input type="number" id="hoaFees" value="200" min="0">
  </div>
  <div class="input-group">
    <label for="hoaInflation">HOA Inflation (%)</label>
    <input type="number" id="hoaInflation" value="3" step="0.01" min="0">
  </div>
</div>



  <h2>üõ†Ô∏è Maintenance</h2>
  <div class="input-grid">
    <div class="input-group">
      <label for="maintenanceValue">
<span class="has-tip"
        tabindex="0"
        data-tip="Maintenance costs are an important but often overlooked part of homeownership. They cover routine upkeep, repairs, and replacements‚Äîeverything from HVAC servicing to roof work and appliance fixes. A common budgeting rule is to set aside about 1% of the home‚Äôs value per year for maintenance.">
Maintenance</label>
      <div class="input-with-select">
        <input type="number" id="maintenanceValue" value="1" step="0.01" min="0">
        <select id="maintenanceType"><option value="percent">% of Home Price (Annual)</option><option value="amount">Fixed Annual Amount</option></select>
      </div>
    </div>
    <div class="input-group"><label for="maintenanceInflation">Maintenance Inflation (%)</label><input type="number" id="maintenanceInflation" value="3" step="0.01" min="0"></div>
  </div>


  <h2>üí° Additional Principal Payments</h2>
  <div class="input-grid">
    <div class="input-group" style="grid-column: 1 / -1">
      <label class="muted">Annual extra payments. A new row appears after each entry. Payments apply in the selected month (e.g., Year 1, Month 12 = 12th month of ownership).</label>
      <div id="extraPrincipalContainer"></div>
      <div class="muted" style="margin-top:.5rem">Tip: Making extra payments on your mortgage - whether from a bonus, tax refund, or any additional income - can reduce your interest costs and significantly shorten the length of your loan.</div>
    </div>

    <div class="input-group" style="grid-column: 1 / -1">
      <label class="muted">Recurring annual extra payment until loan payoff</strong></label>
      <div class="row">
        <select id="recurringExtraMonth">
            
<option value="">Month</option>
<option value="1">Month 1</option>
<option value="2">Month 2</option>
<option value="3">Month 3</option>
<option value="4">Month 4</option>
<option value="5">Month 5</option>
<option value="6">Month 6</option>
<option value="7">Month 7</option>
<option value="8">Month 8</option>
<option value="9">Month 9</option>
<option value="10">Month 10</option>
<option value="11">Month 11</option>
<option value="12">Month 12</option>
</select>
 <input type="number" id="recurringExtraAmount" placeholder="Amount $" min="0" step="100"></label>
        </label>
        <span class="muted">Applied each year on the selected month until balance reaches $0.</span>
      </div>
    </div>
  </div>

  <h2>üè¢ Rental Details</h2>
  <div class="input-grid">
    <div class="input-group"><label for="monthlyRent"><span class="has-tip"
        tabindex="0"
        data-tip="Renting offers flexibility, lower upfront costs, and freedom from expenses like maintenance, taxes, and selling fees. However, it provides less long-term stability - rents often rise over time, while mortgage payments are typically fixed and help build equity.">



Monthly Rent ($)</label><input type="number" id="monthlyRent" value="3000" min="0"></div>
    <div class="input-group"><label for="rentInflation">Annual Rent Increase (%)</label><input type="number" id="rentInflation" value="3" step="0.01"></div>
  </div>

 <h2>‚åõ Years Owned</h2>
<div class="single-input">
  <div class="input-group">
    <label for="yearsOwned">
      <span class="has-tip"
        tabindex="0"
        data-tip="Enter how many years you plan to own the home. This affects calculations such as total costs, equity built, and net benefit of ownership over that duration.">
        Years Owned
      </span>
    </label>
    <input type="number" id="yearsOwned" value="10" min="1">
  </div>
</div>

 <h2>üí∞ Tax Benefit (not included)</h2>
<div class="single-input">
  <div class="input-group">
    <p class="muted">
      <strong>Heads up:</strong> This calculator does <em>not</em> include any potential tax savings from
      <span class="has-tip" tabindex="0" data-tip="Itemizing means listing eligible deductions (e.g., mortgage interest and property tax, subject to the SALT cap) instead of taking the standard deduction.">itemizing your deductions</span>.
      Results below assume the standard deduction and exclude any incremental tax benefit from owning a home.
    </p>
    <p class="muted" style="margin-top:.5rem">
      To see whether your home purchase could reduce your taxes, use the
      <a href="https://mikejohnedwards.github.io/Homebuyer-Tax-Benefit-Calculator/" target="_blank" rel="noopener" class="link">Homebuyer Tax-Benefit Calculator</a>.
    </p>
  </div>
</div>





 <div class="toolbar">
  <!-- (1) Show cents toggle -->
  <label class="chip">
    <input type="checkbox" id="toggleCents"> Show cents
  </label>

  <!-- (3) Net benefit selling cost mode -->
  <label class="chip">
    <span class="has-tip"
      tabindex="0"
      style="white-space: nowrap;" 
      data-tip="If you select ‚Äúdeduct selling cost every month,‚Äù the table, once calculated, will show selling costs at each step, giving a true net benefit if sold at any point.">
      Net Benefit Mode:   
    </span>
    <select id="netBenefitMode" class="push-right">
      <option value="sale_only" selected>Deduct selling cost only at sale</option>
      <option value="every_month">Deduct selling cost every month</option>
    </select>
  </label>
</div>

  <div class="primary-actions">
    <button onclick="compareCosts()">Calculate Comparison</button>
    <button id="downloadCsvBtn" disabled>Download CSV</button>
  </div>

  <div id="results" class="results-container"></div>
</div>




<script>
// (1) Show cents toggle: state is derived from checkbox
let showCents = true;
function syncCentsToggle() {
  const el = document.getElementById('toggleCents');
  showCents = !!el?.checked;
}
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency', currency: 'USD',
    minimumFractionDigits: showCents ? 2 : 0,
    maximumFractionDigits: showCents ? 2 : 0
  }).format(amount);
}
function formatTimeLabel(month) {
  const years = Math.floor((month - 1) / 12);
  const months = month - (years * 12);
  if (months === 12) return `${years + 1} Years`;
  if (years === 0) return `${months} Month${months === 1 ? '' : 's'}`;
  if (months === 0) return `${years} Year${years === 1 ? '' : 's'}`;
  return `${years} Year${years === 1 ? '' : 's'} ${months} Month${months === 1 ? '' : 's'}`;
}
function getNumericValue(id) {
  const input = document.getElementById(id);
  const value = (input.value || '').toString().replace(/,/g, '');
  return parseFloat(value) || 0;
}

// EXTRA PRINCIPAL UI ------------------------------
let paymentRowId = 0;
function monthName(m){return `Month ${m}`;}
function buildYearOptions() {
  const yearsOwned = Math.max(1, parseInt(document.getElementById('yearsOwned').value || '1', 10));
  const opts = [];
  for (let y = 1; y <= yearsOwned; y++) { opts.push(`<option value="${y}">Year ${y}</option>`); }
  return opts.join('');
}
function ensureAtLeastOneExtraRow() {
  const c = document.getElementById('extraPrincipalContainer');
  if (c.querySelectorAll('.row').length === 0) addExtraRow();
}
function addExtraRow(prefill) {
  const c = document.getElementById('extraPrincipalContainer');
  const id = ++paymentRowId;
  const row = document.createElement('div');
  row.className = 'row';
  row.dataset.rowId = id;
  row.innerHTML = `
    <select class="yearSel"><option value="">Year</option>${buildYearOptions()}</select>
    <select class="monthSel">
      <option value="">Month</option>
      ${Array.from({length:12},(_,i)=>`<option value="${i+1}">${monthName(i+1)}</option>`).join('')}
    </select>
    <input type="number" class="amtInput" placeholder="Amount $" min="0" step="100">
    <span class="danger" title="Remove" onclick="this.parentElement.remove(); ensureAtLeastOneExtraRow();">‚úï</span>
  `;
  c.appendChild(row);
  const yearSel = row.querySelector('.yearSel');
  const monthSel = row.querySelector('.monthSel');
  const amtInput = row.querySelector('.amtInput');
  if (prefill) {
    if (prefill.year) yearSel.value = prefill.year;
    if (prefill.month) monthSel.value = prefill.month;
    if (prefill.amount) amtInput.value = prefill.amount;
  }
  const onAnyChange = () => { maybeAppendAnotherRow(); };
  yearSel.addEventListener('change', onAnyChange);
  monthSel.addEventListener('change', onAnyChange);
  amtInput.addEventListener('input', onAnyChange);
}
function rowIsFilled(row) {
  const y = row.querySelector('.yearSel').value;
  const m = row.querySelector('.monthSel').value;
  const a = parseFloat(row.querySelector('.amtInput').value);
  return y && m && a > 0;
}
function maybeAppendAnotherRow() {
  const c = document.getElementById('extraPrincipalContainer');
  const rows = Array.from(c.querySelectorAll('.row'));
  if (rows.length === 0) { addExtraRow(); return; }
  const last = rows[rows.length - 1];
  if (rowIsFilled(last)) { addExtraRow(); }
}
function readExtraPaymentsManual() {
  const c = document.getElementById('extraPrincipalContainer');
  const rows = Array.from(c.querySelectorAll('.row'));
  const out = [];
  for (const r of rows) {
    const year = parseInt(r.querySelector('.yearSel').value, 10);
    const month = parseInt(r.querySelector('.monthSel').value, 10);
    const amount = parseFloat(r.querySelector('.amtInput').value || '0');
    if (year && month && amount > 0) {
      const monthIndex = (year - 1) * 12 + month; // 1-based month index
      out.push({ monthIndex, amount });
    }
  }
  return out;
}
function readExtraPaymentsRecurring(monthsOwned) {
  const amount = parseFloat(document.getElementById('recurringExtraAmount').value || '0');
  const month = parseInt(document.getElementById('recurringExtraMonth').value || '0', 10);
  if (!(amount > 0 && month >= 1 && month <= 12)) return [];
  const out = [];
  for (let y = 1; y <= Math.ceil(monthsOwned / 12); y++) {
    const idx = (y - 1) * 12 + month;
    if (idx >= 1 && idx <= monthsOwned) out.push({ monthIndex: idx, amount });
  }
  return out;
}
function combineExtraMaps(list) {
  const byMonth = {};
  for (const entry of list) {
    const { monthIndex, amount } = entry;
    byMonth[monthIndex] = (byMonth[monthIndex] || 0) + amount;
  }
  return byMonth;
}
function refreshYearOptionsInRows() {
  const maxYear = Math.max(1, parseInt(document.getElementById('yearsOwned').value || '1', 10));
  const opts = Array.from({length: maxYear}, (_,i)=>`<option value="${i+1}">Year ${i+1}</option>`).join('');
  document.querySelectorAll('#extraPrincipalContainer .yearSel').forEach(sel=>{
    const cur = parseInt(sel.value || '0', 10);
    sel.innerHTML = `<option value="">Year</option>${opts}`;
    if (!cur || cur > maxYear) sel.value = '';
  });
}

// CSV + chart + table state -----------------------
let latestRows = [], latestHeaders = [];
let chart1, chart2;
let monthlyDetails = []; // per-month objects for rendering table in different granularities
let tableMode = 'monthly'; // 'monthly' | 'yearly'

function computeStepYears(years) {
  if (years <= 12) return 1;
  if (years <= 24) return 2;
  if (years <= 50) return 5;
  return 10;
}

function calcMonthlyPayment(loanAmount, monthlyInterest, nMonths) {
  if (loanAmount <= 0 || nMonths <= 0) return 0;
  if (Math.abs(monthlyInterest) < 1e-12) return loanAmount / nMonths; // zero-rate guard
  return (monthlyInterest * loanAmount) / (1 - Math.pow(1 + monthlyInterest, -nMonths));
}

function compareCosts() {
  syncCentsToggle(); // reflect UI
  latestRows = [];
  monthlyDetails = [];
  latestHeaders = [
    "Period","Principal","Down Payment & Additional Principal","Interest","HOA","Insurance","Maintenance","Property Tax",
    "Closing Cost (Buy)","Ownership Cost","Rent","Variance","Ownership Surplus Invested",
    "Rent Surplus Invested","Home Value","Loan Outstanding","Equity","Selling Cost (at sale)",
    "Sale Realized (at sale)","Net Benefit of Ownership"
  ];

  const homePrice = getNumericValue("homePrice");
  const downType = document.getElementById("downPaymentType").value;
  const downValue = getNumericValue("downPaymentValue");
  const downPayment = downType === "percent" ? homePrice * (downValue / 100) : downValue;
  const loanAmount = Math.max(0, homePrice - downPayment);
  const interestRate = getNumericValue("interestRate") / 100;
  const loanTerm = getNumericValue("loanTerm");
  const customMonthlyPayment = getNumericValue("customMonthlyPayment");

  const monthlyInterest = interestRate / 12;
  const nMonths = Math.max(1, Math.round(loanTerm * 12));
  const defaultPayment = calcMonthlyPayment(loanAmount, monthlyInterest, nMonths);
  const monthlyMortgage = customMonthlyPayment > 0 ? customMonthlyPayment : defaultPayment;

  // Basic input validations
  if (homePrice <= 0) { alert('Home price must be greater than 0.'); return; }
  if (downPayment < 0 || downPayment > homePrice) { alert('Down payment must be between 0 and the home price.'); return; }
  if (interestRate < 0) { alert('Interest rate cannot be negative.'); return; }
  if (customMonthlyPayment > 0 && (customMonthlyPayment < (loanAmount * monthlyInterest))) {
    alert('Custom payment is less than month-one interest. Increase the payment or clear the custom payment to use the calculated amount.');
    return;
  }

  const propertyTaxType = document.getElementById("propertyTaxType").value;
  let propertyTaxAnnual = propertyTaxType === "percent"
    ? homePrice * (getNumericValue("propertyTaxValue") / 100)
    : getNumericValue("propertyTaxValue");
  const propTaxInflation = getNumericValue("propertyTaxInflation") / 100;

  const homeInsuranceType = document.getElementById("homeInsuranceType").value;
  let insuranceAnnual = homeInsuranceType === "percent"
    ? homePrice * (getNumericValue("homeInsuranceValue") / 100)
    : getNumericValue("homeInsuranceValue");
  const insInflation = getNumericValue("insuranceInflation") / 100;

  let hoaMonthly = getNumericValue("hoaFees");
  const hoaInflation = getNumericValue("hoaInflation") / 100;

  const maintenanceType = document.getElementById("maintenanceType").value;
  let maintenanceAnnual = maintenanceType === "percent"
    ? homePrice * (getNumericValue("maintenanceValue") / 100)
    : getNumericValue("maintenanceValue");
  const maintenanceInflation = getNumericValue("maintenanceInflation") / 100;

  const appreciationRate = getNumericValue("appreciationRate") / 100;
  const yearsOwned = Math.max(1, getNumericValue("yearsOwned"));
  const monthsOwned = Math.max(1, Math.round(yearsOwned * 12));
  const closingBuy = getNumericValue("closingCostsBuy") / 100;
  const closingSell = getNumericValue("closingCostsSell") / 100;
  const returnRate = Math.max(0, getNumericValue("savingsReturnRate") / 100);
  let rent = getNumericValue("monthlyRent");
  const rentInflation = getNumericValue("rentInflation") / 100;

  // (4) Read extra principal: manual + recurring
  const manual = readExtraPaymentsManual();
  const recurring = readExtraPaymentsRecurring(monthsOwned);
  const extraByMonth = combineExtraMaps([...manual, ...recurring]); // {monthIndex: amount}

  let balance = loanAmount;
  let homeValue = homePrice;
  let principalOnlyTotal = 0, extraPrincipalTotal = 0, interestTotal = 0, totalRent = 0, totalOwner = 0;
  let totalHOA = 0, totalInsurance = 0, totalMaintenance = 0, totalPropertyTax = 0;

  let taxMonthly = propertyTaxAnnual / 12;
  let insuranceMonthly = insuranceAnnual / 12;
  let maintenanceMonthly = maintenanceAnnual / 12;

  const buyClosingCostAmount = homePrice * closingBuy;
  const cashAtClose = downPayment + buyClosingCostAmount; // show separately in summary

  let ownershipInvested = 0;
  let rentInvested = 0;

  // Series (use numeric X = month index for safer ticks)
  const labels = []; // 1..monthsOwned (numeric)
  const netBenefitSeries = [];
  const equitySeries = [];

  const netBenefitMode = document.getElementById('netBenefitMode').value; // 'sale_only' | 'every_month'

  for (let month = 1; month <= monthsOwned; month++) {
    let interest = balance * monthlyInterest;
    let principal = Math.min(monthlyMortgage - interest, balance);
    if (principal < 0) principal = 0;
    balance -= principal;

    let extraPrincipal = 0;
    if (extraByMonth[month]) {
      extraPrincipal = Math.min(extraByMonth[month], balance);
      balance -= extraPrincipal;
    }

    const closingCostThisMonth = month === 1 ? buyClosingCostAmount : 0;
// include down payment in the "Down Payment & Additional Principal" column on month 1 (do not subtract from balance again)
if (month === 1 && downPayment > 0) { extraPrincipal += downPayment; }

const ownerCost = principal + extraPrincipal + interest + taxMonthly + insuranceMonthly + hoaMonthly + maintenanceMonthly + closingCostThisMonth;
    const variance = rent - ownerCost; // positive => renting costs more

    principalOnlyTotal += principal;
    extraPrincipalTotal += extraPrincipal;
    interestTotal += interest;
    totalRent += rent;
    totalOwner += ownerCost;
    totalHOA += hoaMonthly;
    totalInsurance += insuranceMonthly;
    totalMaintenance += maintenanceMonthly;
    totalPropertyTax += taxMonthly;

    if (month > 1) {
      ownershipInvested *= (1 + returnRate / 12);
      rentInvested      *= (1 + returnRate / 12);
    }
    if (variance >= 0) ownershipInvested += variance; else rentInvested += -variance;

    homeValue *= (1 + appreciationRate / 12);
    const equity = homeValue - balance;

    // (3) Net benefit selling cost deduction per mode
    let sellClosingCostThisMonth = 0;
let saleRealized = 0;
if (netBenefitMode === 'every_month') {
  sellClosingCostThisMonth = homeValue * closingSell;
  saleRealized = equity - sellClosingCostThisMonth;
} else if (month === monthsOwned) {
  sellClosingCostThisMonth = homeValue * closingSell;
  saleRealized = equity - sellClosingCostThisMonth;
}
const sellingCostApplied = sellClosingCostThisMonth;
const netBenefit = equity - rentInvested + ownershipInvested - sellingCostApplied;

    labels.push(month);
    netBenefitSeries.push(netBenefit);
    equitySeries.push(equity);

    monthlyDetails.push({
      monthIndex: month,
      periodLabel: formatTimeLabel(month),
      principal, extraPrincipal, interest,
      hoa: hoaMonthly, insurance: insuranceMonthly, maintenance: maintenanceMonthly, propertyTax: taxMonthly,
      closingCostBuy: closingCostThisMonth,
      ownershipCost: ownerCost,
      rent,
      variance,
      ownershipInvested, rentInvested,
      homeValue, loanOutstanding: balance, equity,
      sellingCost: sellClosingCostThisMonth,
      saleRealized,
      netBenefit
    });

    if (month % 12 === 0) {
      propertyTaxAnnual *= (1 + propTaxInflation); taxMonthly = propertyTaxAnnual / 12;
      insuranceAnnual *= (1 + insInflation);        insuranceMonthly = insuranceAnnual / 12;
      hoaMonthly     *= (1 + hoaInflation);
      maintenanceAnnual *= (1 + maintenanceInflation); maintenanceMonthly = maintenanceAnnual / 12;
      rent *= (1 + rentInflation);
    }

    if (balance <= 0.005) { balance = 0;
      if (month < monthsOwned) {
        for (let m = month + 1; m <= monthsOwned; m++) {
          homeValue *= (1 + appreciationRate / 12);
          const ownerCost2 = taxMonthly + insuranceMonthly + hoaMonthly + maintenanceMonthly; // no P&I after payoff
          const variance2 = rent - ownerCost2;
          ownershipInvested *= (1 + returnRate / 12);
          rentInvested      *= (1 + returnRate / 12);
          if (variance2 >= 0) ownershipInvested += variance2; else rentInvested += -variance2;
          const equity2 = homeValue;

          let sellClosingCostThisMonth2 = 0;
let saleRealized2 = 0;
if (netBenefitMode === 'every_month') {
  sellClosingCostThisMonth2 = homeValue * closingSell;
  saleRealized2 = equity2 - sellClosingCostThisMonth2;
} else if (m === monthsOwned) {
  sellClosingCostThisMonth2 = homeValue * closingSell;
  saleRealized2 = equity2 - sellClosingCostThisMonth2;
}
const netBenefit2 = equity2 - rentInvested + ownershipInvested - sellClosingCostThisMonth2;

          monthlyDetails.push({
            monthIndex: m, periodLabel: formatTimeLabel(m),
            principal: 0, extraPrincipal: 0, interest: 0,
            hoa: hoaMonthly, insurance: insuranceMonthly, maintenance: maintenanceMonthly, propertyTax: taxMonthly,
            closingCostBuy: 0,
            ownershipCost: ownerCost2,
            rent, variance: variance2,
            ownershipInvested, rentInvested,
            homeValue, loanOutstanding: 0, equity: equity2,
            sellingCost: sellClosingCostThisMonth2,
            saleRealized: saleRealized2,
            netBenefit: netBenefit2
          });
          if (m % 12 === 0) {
            propertyTaxAnnual *= (1 + propTaxInflation); taxMonthly = propertyTaxAnnual / 12;
            insuranceAnnual *= (1 + insInflation);        insuranceMonthly = insuranceAnnual / 12;
            hoaMonthly     *= (1 + hoaInflation);
            maintenanceAnnual *= (1 + maintenanceInflation); maintenanceMonthly = maintenanceAnnual / 12;
            rent *= (1 + rentInflation);
          }
        }
      }
      break;
    }
  }

  const totalPrincipalPaid = principalOnlyTotal + extraPrincipalTotal;
  const finalSnap = monthlyDetails[monthlyDetails.length - 1];
  const finalEquity = finalSnap.equity;
  const finalNetBenefit = finalSnap.netBenefit;

  document.getElementById("results").innerHTML = `
    <div class="summary">
      <h3>üìä Summary After ${yearsOwned} Years</h3>
      <div class="summary-grid">
        <div class="summary-item"><strong>Total Principal Paid</strong> ${formatCurrency(totalPrincipalPaid)}</div>
        <div class="summary-item"><strong>Total Interest Paid</strong> ${formatCurrency(interestTotal)}</div>
        <div class="summary-item"><strong>Total Rent Paid</strong> ${formatCurrency(totalRent)}</div>
        <div class="summary-item"><strong>Final Home Value</strong> ${formatCurrency(finalSnap.homeValue)}</div>
        <div class="summary-item"><strong>Total Equity</strong> ${formatCurrency(finalEquity)}</div>
        <div class="summary-item"><strong>Ownership Surplus Invested</strong> ${formatCurrency(finalSnap.ownershipInvested)}</div>
        <div class="summary-item"><strong>Rent Surplus Invested</strong> ${formatCurrency(finalSnap.rentInvested)}</div>
        <div class="summary-item"><strong>Net Benefit of Ownership</strong>
          <span class= "${finalNetBenefit < 0 ? 'negative' : 'positive'}">${formatCurrency(finalNetBenefit)}</span>
        </div>
      </div>
    </div>

    <div class="table-controls">
      <label for="tableModeSelect"><strong>Table view:</strong></label>
      <select id="tableModeSelect">
        <option value="monthly" selected>Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <div id="tableMount"></div>

    <div class="charts">
      <div class="chart-card">
        <h4>Cumulative Owner Outlay vs Rent Outlay</h4>
        <canvas id="chartOutlay"></canvas>
      </div>
      <div class="chart-card">
        <h4>Equity + Ownership Surplus Invested vs Renter Surplus Invested and Net Benefit of Ownership</h4>
        <canvas id="chartEquity"></canvas>
      </div>
    </div>
  `;

  const modeSelect = document.getElementById('tableModeSelect');
  modeSelect.onchange = () => { tableMode = modeSelect.value; renderTable(); };
  tableMode = 'monthly';
  renderTable();

  const btn = document.getElementById('downloadCsvBtn');
  btn.disabled = false;
  btn.onclick = () => downloadCSV(latestHeaders, latestRows, `rent-vs-mortgage-${tableMode}-${Date.now()}.csv`);

  // (2) Chart axes and tooltips show Year + Month
  const ctx1 = document.getElementById('chartOutlay').getContext('2d');
  const ctx2 = document.getElementById('chartEquity').getContext('2d');
  if (chart1) chart1.destroy();
  if (chart2) chart2.destroy();

  const totalMonths = monthlyDetails.length;
const xScale = {
  type: 'linear',
  min: 1,
  max: totalMonths,
  ticks: {
    stepSize: 12,        // force one tick every 12 months
    autoSkip: false,     // don‚Äôt let Chart.js hide ticks
    precision: 0,        // keep integer tick values
    callback: (val) => {
      // ticks will be 12, 24, 36, ...
      if (!Number.isInteger(val)) return '';
      if (val >= 12 && val % 12 === 0) {
        const year = val / 12;
        return `${year} year${year > 1 ? 's' : ''}`;
      }
      return '';
    }
  },
  grid: { display: true }
};

  chart1 = new Chart(ctx1, {
    type: 'line',
    data: {
      datasets: [
        { label: 'Cumulative Owner Outlay', data: cumulativeFrom(monthlyDetails.map(d => d.ownershipCost)).map((y,i)=>({x:i+1,y})), borderWidth: 2, tension: 0.15, pointRadius: 0 },
        { label: 'Cumulative Rent Outlay',  data: cumulativeFrom(monthlyDetails.map(d => d.rent)).map((y,i)=>({x:i+1,y})), borderWidth: 2, tension: 0.15, pointRadius: 0 }]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            title: (items)=> formatTimeLabel(items[0].parsed.x),
            label: (ctx)=> `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        y: { ticks: { callback: (v)=> formatCurrency(v) } },
        x: xScale
      }
    }
  });

  chart2 = new Chart(ctx2, {
    type: 'line',
    data: {
      datasets: [
        { label: 'Equity + Ownership Surplus Invested', data: monthlyDetails.map((d,i)=>({x:i+1,y:d.equity + d.ownershipInvested})), borderWidth: 2, tension: 0.15, pointRadius: 0 },
        { label: 'Renter Surplus Invested', data: monthlyDetails.map((d,i)=>({x:i+1,y:d.rentInvested})), borderWidth: 2, tension: 0.15, pointRadius: 0 },
	{ label: 'Net Benefit of Ownership', data: monthlyDetails.map((d,i)=>({x:i+1,y:d.netBenefit})), borderWidth: 2, tension: 0.15, pointRadius: 0 }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            title: (items)=> formatTimeLabel(items[0].parsed.x),
            label: (ctx)=> `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}`
          }
        }
      },
      scales: {
        y: { ticks: { callback: (v)=> formatCurrency(v) } },
        x: xScale
      }
    }
  });
}

// helpers -----------------------------------------
function cumulativeFrom(arr) {
  const out = []; let sum = 0;
  for (const v of arr) { sum += v; out.push(sum); }
  return out;
}

// Build table for current tableMode and update latestRows/latestHeaders
function renderTable() {
  const mount = document.getElementById('tableMount');
  if (tableMode === 'monthly') {
    latestHeaders = [
      "Period","Principal","Down Payment & Additional Principal","Interest","HOA","Insurance","Maintenance","Property Tax",
      "Closing Cost (Buy)","Ownership Cost","Rent","Variance","Ownership Surplus Invested",
      "Rent Surplus Invested","Home Value","Loan Outstanding","Equity","Selling Cost (at sale)",
      "Sale Realized (at sale)","Net Benefit of Ownership"
    ];
    const rowsHtml = monthlyDetails.map(d => {
      return `<tr>
        <td><strong>${d.periodLabel}</strong></td>
        <td>${formatCurrency(d.principal)}</td>
        <td>${formatCurrency(d.extraPrincipal)}</td>
        <td>${formatCurrency(d.interest)}</td>
        <td>${formatCurrency(d.hoa)}</td>
        <td>${formatCurrency(d.insurance)}</td>
        <td>${formatCurrency(d.maintenance)}</td>
        <td>${formatCurrency(d.propertyTax)}</td>
        <td>${formatCurrency(d.closingCostBuy)}</td>
        <td>${formatCurrency(d.ownershipCost)}</td>
        <td>${formatCurrency(d.rent)}</td>
        <td class="${d.variance < 0 ? 'negative' : 'positive'}">${formatCurrency(d.variance)}</td>
        <td>${formatCurrency(d.ownershipInvested)}</td>
        <td>${formatCurrency(d.rentInvested)}</td>
        <td>${formatCurrency(d.homeValue)}</td>
        <td>${formatCurrency(d.loanOutstanding)}</td>
        <td>${formatCurrency(d.equity)}</td>
        <td>${formatCurrency(d.sellingCost)}</td>
        <td>${formatCurrency(d.saleRealized)}</td>
        <td class="${d.netBenefit < 0 ? 'negative' : 'positive'}">${formatCurrency(d.netBenefit)}</td>
      </tr>`;
    }).join('');

    const last = monthlyDetails[monthlyDetails.length - 1];
    const totals = {
      principal: monthlyDetails.reduce((s,d)=>s+d.principal,0),
      extraPrincipal: monthlyDetails.reduce((s,d)=>s+d.extraPrincipal,0),
      interest: monthlyDetails.reduce((s,d)=>s+d.interest,0),
      hoa: monthlyDetails.reduce((s,d)=>s+d.hoa,0),
      insurance: monthlyDetails.reduce((s,d)=>s+d.insurance,0),
      maintenance: monthlyDetails.reduce((s,d)=>s+d.maintenance,0),
      propertyTax: monthlyDetails.reduce((s,d)=>s+d.propertyTax,0),
      closingCostBuy: monthlyDetails.reduce((s,d)=>s+d.closingCostBuy,0),
      ownershipCost: monthlyDetails.reduce((s,d)=>s+d.ownershipCost,0),
      rent: monthlyDetails.reduce((s,d)=>s+d.rent,0),
      variance: monthlyDetails.reduce((s,d)=>s+d.variance,0),
    };

    mount.innerHTML = `
      <div class="table-container"><table>
        <thead><tr>
          <th>Period</th><th>Principal</th><th>Down Payment & Additional Principal</th><th>Interest</th><th>HOA</th><th>Insurance</th><th>Maintenance</th><th>Property Tax</th>
          <th>Closing Cost</th><th>Ownership Cost</th><th>Rent</th><th>Variance</th><th>Ownership Surplus Invested</th>
          <th>Rent Surplus Invested</th><th>Home Value</th><th>Loan Outstanding</th><th>Equity</th><th>Selling Cost</th>
          <th>Sale Realized</th><th>Net Benefit of Ownership</th>
        </tr></thead>
        <tbody>
          ${rowsHtml}
          <tr class="totals-row">
            <td><strong>TOTALS</strong></td>
            <td>${formatCurrency(totals.principal)}</td>
            <td>${formatCurrency(totals.extraPrincipal)}</td>
            <td>${formatCurrency(totals.interest)}</td>
            <td>${formatCurrency(totals.hoa)}</td>
            <td>${formatCurrency(totals.insurance)}</td>
            <td>${formatCurrency(totals.maintenance)}</td>
            <td>${formatCurrency(totals.propertyTax)}</td>
            <td>${formatCurrency(totals.closingCostBuy)}</td>
            <td>${formatCurrency(totals.ownershipCost)}</td>
            <td>${formatCurrency(totals.rent)}</td>
            <td class="${totals.variance < 0 ? 'negative' : 'positive'}">${formatCurrency(totals.variance)}</td>
            <td>${formatCurrency(last.ownershipInvested)}</td>
            <td>${formatCurrency(last.rentInvested)}</td>
            <td>${formatCurrency(last.homeValue)}</td>
            <td>${formatCurrency(last.loanOutstanding)}</td>
            <td>${formatCurrency(last.equity)}</td>
            <td>${formatCurrency(last.sellingCost)}</td>
            <td>${formatCurrency(last.saleRealized)}</td>
            <td class="${last.netBenefit < 0 ? 'negative' : 'positive'}">${formatCurrency(last.netBenefit)}</td>
          </tr>
        </tbody>
      </table></div>
    `;

    // CSV rows (monthly)
    latestRows = monthlyDetails.map(d => [
      d.periodLabel, d.principal.toFixed(2), d.extraPrincipal.toFixed(2), d.interest.toFixed(2), d.hoa.toFixed(2), d.insurance.toFixed(2),
      d.maintenance.toFixed(2), d.propertyTax.toFixed(2), d.closingCostBuy.toFixed(2), d.ownershipCost.toFixed(2),
      d.rent.toFixed(2), d.variance.toFixed(2), d.ownershipInvested.toFixed(2), d.rentInvested.toFixed(2),
      d.homeValue.toFixed(2), d.loanOutstanding.toFixed(2), d.equity.toFixed(2), d.sellingCost.toFixed(2),
      d.saleRealized.toFixed(2), d.netBenefit.toFixed(2)
    ]);

  } else {
    // YEARLY aggregation
    latestHeaders = [
      "Year","Principal","Down Payment & Additional Principal","Interest","HOA","Insurance","Maintenance","Property Tax",
      "Closing Cost (Buy)","Ownership Cost","Rent","Variance","Ownership Surplus Invested (EOY)",
      "Rent Surplus Invested (EOY)","Home Value (EOY)","Loan Outstanding (EOY)","Equity (EOY)",
      "Selling Cost (at sale)","Sale Realized (at sale)","Net Benefit of Ownership (EOY)"
    ];

    const years = Math.ceil(monthlyDetails.length / 12);
    const yearRows = [];
    for (let y = 1; y <= years; y++) {
      const start = (y - 1) * 12;
      const slice = monthlyDetails.slice(start, start + 12);
      const endSnap = slice[slice.length - 1];
      const sum = (k) => slice.reduce((s,d)=>s + d[k], 0);
      yearRows.push({
        year: y,
        principal: sum('principal'),
        extraPrincipal: sum('extraPrincipal'),
        interest: sum('interest'),
        hoa: sum('hoa'),
        insurance: sum('insurance'),
        maintenance: sum('maintenance'),
        propertyTax: sum('propertyTax'),
        closingCostBuy: sum('closingCostBuy'),
        ownershipCost: sum('ownershipCost'),
        rent: sum('rent'),
        variance: sum('variance'),
        ownershipInvested: endSnap.ownershipInvested,
        rentInvested: endSnap.rentInvested,
        homeValue: endSnap.homeValue,
        loanOutstanding: endSnap.loanOutstanding,
        equity: endSnap.equity,
        sellingCost: endSnap.sellingCost,
        saleRealized: endSnap.saleRealized,
        netBenefit: endSnap.netBenefit
      });
    }

    const rowsHtml = yearRows.map(r => `
      <tr>
        <td><strong>Year ${r.year}</strong></td>
        <td>${formatCurrency(r.principal)}</td>
        <td>${formatCurrency(r.extraPrincipal)}</td>
        <td>${formatCurrency(r.interest)}</td>
        <td>${formatCurrency(r.hoa)}</td>
        <td>${formatCurrency(r.insurance)}</td>
        <td>${formatCurrency(r.maintenance)}</td>
        <td>${formatCurrency(r.propertyTax)}</td>
        <td>${formatCurrency(r.closingCostBuy)}</td>
        <td>${formatCurrency(r.ownershipCost)}</td>
        <td>${formatCurrency(r.rent)}</td>
        <td class="${r.variance < 0 ? 'negative' : 'positive'}">${formatCurrency(r.variance)}</td>
        <td>${formatCurrency(r.ownershipInvested)}</td>
        <td>${formatCurrency(r.rentInvested)}</td>
        <td>${formatCurrency(r.homeValue)}</td>
        <td>${formatCurrency(r.loanOutstanding)}</td>
        <td>${formatCurrency(r.equity)}</td>
        <td>${formatCurrency(r.sellingCost)}</td>
        <td>${formatCurrency(r.saleRealized)}</td>
        <td class="${r.netBenefit < 0 ? 'negative' : 'positive'}">${formatCurrency(r.netBenefit)}</td>
      </tr>
    `).join('');

    const totals = {
      principal: yearRows.reduce((s,r)=>s+r.principal,0),
      extraPrincipal: yearRows.reduce((s,r)=>s+r.extraPrincipal,0),
      interest: yearRows.reduce((s,r)=>s+r.interest,0),
      hoa: yearRows.reduce((s,r)=>s+r.hoa,0),
      insurance: yearRows.reduce((s,r)=>s+r.insurance,0),
      maintenance: yearRows.reduce((s,r)=>s+r.maintenance,0),
      propertyTax: yearRows.reduce((s,r)=>s+r.propertyTax,0),
      closingCostBuy: yearRows.reduce((s,r)=>s+r.closingCostBuy,0),
      ownershipCost: yearRows.reduce((s,r)=>s+r.ownershipCost,0),
      rent: yearRows.reduce((s,r)=>s+r.rent,0),
      variance: yearRows.reduce((s,r)=>s+r.variance,0),
    };
    const last = yearRows[yearRows.length - 1];

    mount.innerHTML = `
      <div class="table-container"><table>
        <thead><tr>
          <th>Year</th><th>Principal</th><th>Down Payment & Additional Principal</th><th>Interest</th><th>HOA</th><th>Insurance</th><th>Maintenance</th><th>Property Tax</th>
          <th>Closing Cost</th><th>Ownership Cost</th><th>Rent</th><th>Variance</th><th>Ownership Surplus Invested (EOY)</th>
          <th>Rent Surplus Invested (EOY)</th><th>Home Value (EOY)</th><th>Loan Outstanding (EOY)</th><th>Equity (EOY)</th>
          <th>Selling Cost</th><th>Sale Realized</th><th>Net Benefit of Ownership (EOY)</th>
        </tr></thead>
        <tbody>
          ${rowsHtml}
          <tr class="totals-row">
            <td><strong>TOTALS</strong></td>
            <td>${formatCurrency(totals.principal)}</td>
            <td>${formatCurrency(totals.extraPrincipal)}</td>
            <td>${formatCurrency(totals.interest)}</td>
            <td>${formatCurrency(totals.hoa)}</td>
            <td>${formatCurrency(totals.insurance)}</td>
            <td>${formatCurrency(totals.maintenance)}</td>
            <td>${formatCurrency(totals.propertyTax)}</td>
            <td>${formatCurrency(totals.closingCostBuy)}</td>
            <td>${formatCurrency(totals.ownershipCost)}</td>
            <td>${formatCurrency(totals.rent)}</td>
            <td class="${totals.variance < 0 ? 'negative' : 'positive'}">${formatCurrency(totals.variance)}</td>
            <td>${formatCurrency(last.ownershipInvested)}</td>
            <td>${formatCurrency(last.rentInvested)}</td>
            <td>${formatCurrency(last.homeValue)}</td>
            <td>${formatCurrency(last.loanOutstanding)}</td>
            <td>${formatCurrency(last.equity)}</td>
            <td>${formatCurrency(last.sellingCost)}</td>
            <td>${formatCurrency(last.saleRealized)}</td>
            <td class="${last.netBenefit < 0 ? 'negative' : 'positive'}">${formatCurrency(last.netBenefit)}</td>
          </tr>
        </tbody>
      </table></div>
    `;

    // CSV rows (yearly)
    latestRows = yearRows.map(r => [
      `Year ${r.year}`, r.principal.toFixed(2), r.extraPrincipal.toFixed(2), r.interest.toFixed(2), r.hoa.toFixed(2), r.insurance.toFixed(2),
      r.maintenance.toFixed(2), r.propertyTax.toFixed(2), r.closingCostBuy.toFixed(2), r.ownershipCost.toFixed(2),
      r.rent.toFixed(2), r.variance.toFixed(2), r.ownershipInvested.toFixed(2), r.rentInvested.toFixed(2),
      r.homeValue.toFixed(2), r.loanOutstanding.toFixed(2), r.equity.toFixed(2), r.sellingCost.toFixed(2),
      (r.saleRealized||0).toFixed(2), r.netBenefit.toFixed(2)
    ]);
  }
}

// CSV helpers ------------------------------------
function toCsvValue(v) {
  const s = String(v);
  if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
  return s;
}

// NEW: robust CSV downloader (works with Excel, Numbers, Google Sheets)
function downloadCSV(headers, rows, filename = 'table.csv') {
  if (!Array.isArray(rows) || rows.length === 0) {
    alert('No table data to download yet ‚Äî run the calculation first.');
    return;
  }

  const EOL = '\r\n';   // Excel-friendly newlines
  const BOM = '\uFEFF'; // Helps Excel detect UTF-8

  const csv = [
    headers.map(toCsvValue).join(','),
    ...rows.map(r => r.map(toCsvValue).join(','))
  ].join(EOL);

  const blob = new Blob([BOM, csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Bootstrapping of extra principal UI -------------
window.addEventListener('DOMContentLoaded', () => {
  maybeAppendAnotherRow();
  document.getElementById('yearsOwned').addEventListener('input', refreshYearOptionsInRows);
  const cents = document.getElementById('toggleCents');
  cents?.addEventListener('change', () => { compareCosts(); });
  document.getElementById('netBenefitMode')?.addEventListener('change', () => { compareCosts(); });
});
</script>
</body>
</html>
